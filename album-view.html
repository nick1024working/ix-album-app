<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="ix相簿">
    <title>ix相簿 | 瀏覽相簿</title>

    <!-- bootstrap css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/css/bootstrap.min.css" rel="stylesheet">
    <!-- slick-carousel -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" />
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" />
    <!-- font-awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <!-- lightbox by kemiedon -->
    <link rel="stylesheet" type="text/css" href="./css/libs/lightbox.css">

    <!-- 預設全域css -->
    <link rel="stylesheet" href="./css/style.css" />


    <style>
        /* 輪播主要容器 */
        #image-carousel {
            border: 1px solid var(--bs-light);
            background-color: var(--bs-light);
            border-radius: 0.5rem;
            height: 250px;
        }

        /* 放大與父元素同高，並讓其中的子元素 slick-track 垂直置中 */
        .slick-list {
            display: grid;
            place-items: center;
            height: 100%;
        }

        /* 輪播左右側箭頭改色 */
        /* 原因: 背景為白色 */
        .slick-prev::before,
        .slick-next::before {
            color: #6f6f6f;
        }

        /* 強化輪播中相片 hover 效果 */
        /* 原因: 讓使用者覺得可以點擊，已觸發燈箱效果 */
        .hover-zoom {
            transition: transform 0.3s ease;
            cursor: zoom-in;
        }

        .hover-zoom:hover {
            z-index: 3;
            transform: scale(1.1);
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.3);
        }

        /* 提高燈箱 z-index 層級 */
        /* 原因: 讓他比 bootstrap z-index 都要高 */
        .lightbox-overlay {
            z-index: 2000;
        }
    </style>


</head>

<body>
    <!-- BOOKMARK -->
    <header>
        <section class="container-fluid">
            <nav class="navbar navbar-light navbar-expand-sm fixed-top">
                <div class="container">
                    <a class="navbar-brand" href="./index.html">
                        <span style="font-family: Uni0563; line-height: 1;">ixAlbum</span>
                    </a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav ms-3">
                            <li class="nav-item">
                                <a class="nav-link" href="./album-create.html">建立相簿</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="./album-view.html">瀏覽相簿</a>
                            </li>
                            <li class="nav-item">
                                <button id="nav-destroy-btn" class="nav-link" type="button">摧毀相簿</button>
                            </li>
                        </ul>
                        <div class="d-grid gap-2 d-sm-block ms-auto">
                            <button class="btn btn-outline-secondary" type="button">登入</button>
                            <button class="btn btn-info text-light" type="button">註冊</button>
                        </div>
                    </div>
                </div>
            </nav>
        </section>
    </header>
    <!-- BOOKMARK -->
    <main style="padding-top: 80px;">
        <h1 class="display-4 text-center my-3">所有相簿列表</h1>
        <!-- 所有相簿列表 -->
        <section class="container mb-5">
            <div class="list-group" id="album-list">
                <!-- 單一相簿 meta 將在此處插入 -->
            </div>
        </section>

        <!-- 相簿詳情 - meta -->
        <h1 class="display-4 text-center my-3">相簿詳情</h1>
        <section class="container mb-4">
            <!-- 相簿名稱 -->
            <div class="col-12 mb-3">
                <label class="form-label">相簿名稱</label>
                <input type="text" readonly class="form-control bg-white bg-opacity-10 text-white" id="album-name-view"
                    value="" disabled>
            </div>

            <!-- 相簿描述 -->
            <div class="col-12 mb-3">
                <label class="form-label">相簿描述</label>
                <textarea readonly class="form-control bg-white bg-opacity-10 text-white" id="album-description-view"
                    rows="3" disabled></textarea>
            </div>

            <!-- 拍攝/建立日期 -->
            <div class="col-12 row mb-4">
                <label class="col-sm-2 col-form-label">相簿拍攝日期</label>
                <div class="col-sm-4">
                    <input type="text" readonly class="form-control bg-white bg-opacity-10 text-white"
                        id="album-date-view" value="" disabled>
                </div>
                <label class="col-sm-2 col-form-label">相簿建立日期</label>
                <div class="col-sm-4">
                    <input type="text" readonly class="form-control bg-white bg-opacity-10 text-white"
                        id="album-created-date-view" value="" disabled>
                </div>
            </div>
        </section>
        <!-- 相簿詳情 - 內容 -->
        <section class="container mb-4">
            <label class="form-label">相簿內容</label>
            <div class="col-12 mx-auto px-2 py-2 bg-white bg-opacity-10" id="image-carousel">
                <!-- 當前相簿所有照片將在此插入 -->
            </div>
        </section>

        <!-- 操作按鈕 -->
        <section>
            <div class="d-grid gap-2 d-sm-flex justify-content-center">
                <button id="clear-current-btn" class="btn btn-info text-light">
                    刪除當前相簿
                </button>
            </div>
        </section>
    </main>
    <!-- BOOKMARK -->
    <footer>
    </footer>

    <!-- 燈箱用 -->
    <div class="lightbox-overlay">
        <div class="lightbox-content">
            <img alt="" class="lightbox-image">
            <span class="lightbox-close"><i class="fa-solid fa-xmark"></i></span>
        </div>
    </div>

    <!-- BOOKMARK -->
    <!-- Load JavaScript libraries -->
    <!-- jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.7/js/bootstrap.min.js"></script>
    <!-- slick-carousel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.9.0/slick.min.js"></script>
    <!-- lightbox by kemiedon -->
    <script src="./js/libs/lightbox.js"></script>


    <!-- 核心 JS -->
    <script type="module">

        // === 匯入模組 ===
        import { DestroyAlbumModal } from './js/modals/destroyAlbumModal.js';
        import dbContext from './js/utils/dbContext.js';
        import { urlToBlob } from './js/utils/fileHelpers.js';
        import { createAlbumDTO } from './js/models/AlbumDTO.js';

        // === 宣告預設參數 ===
        // 宣告 slick 預設參數
        const slickDefault = {
            infinite: true,
            arrows: true,
            slidesToShow: 5,
            responsive: [
                {
                    breakpoint: 1200,
                    settings: {
                        arrows: true,
                        slidesToShow: 4
                    }
                },
                {
                    breakpoint: 992,
                    settings: {
                        arrows: true,
                        slidesToShow: 3
                    }
                },
                {
                    breakpoint: 768,
                    settings: {
                        arrows: false,
                        slidesToShow: 2
                    }
                }
                ,
                {
                    breakpoint: 576,
                    settings: {
                        arrows: false,
                        slidesToShow: 1
                    }
                }
            ]
        };

        // ===  jQuery 元素快取 ===
        const $carousel = $('#image-carousel');
        const $albumList = $('#album-list');

        // === 物件 & 資料初始化 ===
        await dbContext.init();

        // ===  畫面渲染 ===

        // 渲染相簿 (有新增 DOM element)
        const albums = await dbContext.getAllItems();       // 讀取所有相簿資料
        $albumList.empty();     // 清空原列表

        // 若沒有任何相簿，則新增一本佔位相簿
        if (albums.length === 0) {
            const placeholderAlbum = await createPlaceholderAlbum();
            dbContext.addItem(placeholderAlbum);
        }

        for (const { key, value } of albums) {
            const html = `
                <button type="button" data-album-id="${key}"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                    <div class="ps-1 pe-3 py-2">
                        <h5 class="fw-bold mb-1">${value.name}</h5>
                        <span class="text-black-50">${value.description || '無相簿描述...'}</span>
                    </div>
                    <span class="badge bg-secondary rounded-pill">${value.photos.length}</span>
                </button>
            `;
            $albumList.append(html);
        }

        // ===  事件綁定 ===

        // 點擊相簿，載入相簿 meta、載入照片並啟動 Slick
        $albumList.on('click', 'button', async function (event) {

            // 改變狀態
            $albumList.find('.list-group-item').removeClass('active');
            $(this).addClass('active');

            const albumId = $(this).data('album-id');
            const queryResult = albums.find(a => String(a.key) === String(albumId));
            if (queryResult === null) {
                alert('相簿無照片');
                return;
            }
            const photoList = queryResult.value.photos;

            // 載入相簿 meta
            fillAlbumMeta(queryResult);

            // 如果 slick 已初始化過，需先移除
            if ($carousel.hasClass('slick-initialized')) {
                $carousel.slick('unslick');
            }

            // 清空內容，加入圖片
            $carousel.empty();
            for (const img of photoList) {
                const url = URL.createObjectURL(img.blob);
                const htmlString = `
                    <div>
                        <a href="${url}" class="lightbox">
                            <img src="${url}" class="img-thumbnail hover-zoom m-auto" style="height: 180px; width: 180px;">
                        </a>
                    </div>`;
                $carousel.append(htmlString);
            }

            // 重新啟動 slick
            $carousel.slick(slickDefault);
        });

        // 清除當前相簿資料
        $('#clear-current-btn').on('click', async function () {
            const $target = $albumList.find('button.active');
            if ($target.length === 0) {
                alert('請先選擇一個相簿');
                return;
            }

            // 取得 id 並從 DB, 畫面中的 album-list, 與 image-carousel 中移除。
            const albumId = $target.data('album-id');
            try {
                await dbContext.deleteItem(albumId); // 從 IndexedDB 刪除
                $target.remove();                    // 從列表移除
                $carousel.empty();                   // 清空圖片輪播區
            } catch (err) {
                console.error('刪除失敗', err);
                alert('刪除相簿時發生錯誤');
            }
        })

        // 建立佔位相簿
        async function createPlaceholderAlbum() {
            const blob = await urlToBlob('./assets/images/placeholder-1000x1000.png');
            const placeholderImage = {
                name: '空照片',
                type: 'image/png',
                blob: blob,
            }
            const now = Date.now();
            const meta = {
                name: '新增相簿',
                description: '這本相簿裡沒有值得查看的記憶',
                dateTaken: "1960-04-16 14:59",
                createdAt: new Date(),
            };
            const photoList = [
                placeholderImage,
                placeholderImage,
                placeholderImage,
                placeholderImage,
                placeholderImage,
            ]
            return createAlbumDTO(meta, photoList);
        }

        // === 工具函數

        function fillAlbumMeta(album) {
            if (!album) return;

            document.getElementById('album-name-view').value = album.value.name || '';
            document.getElementById('album-description-view').value = album.value.description || '';
            document.getElementById('album-date-view').value = album.value.dateTaken || '';
            document.getElementById('album-created-date-view').value = album.value.createdAt || '';
        }

        // 點擊上方 nav-bar 摧毀相簿按鈕
        document.getElementById('nav-destroy-btn').addEventListener('click', () => {
            new DestroyAlbumModal(dbContext.deleteAllItems);

        })
    </script>

</body>

</html>